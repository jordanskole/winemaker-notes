// Ionic Starter App

// angular.module is a global place for creating, registering and retrieving Angular modules
// 'starter' is the name of this angular module example (also set in a <body> attribute in index.html)
// the 2nd parameter is an array of 'requires'

var app = angular.module('wineApp', ['ionic', 'firebase', 'ngCordova']);
var fb = new Firebase("https://winemaker-notes.firebaseio.com");

app.config(function($httpProvider, $stateProvider, $urlRouterProvider) {

  $httpProvider.defaults.useXDomain = true;
  // don't put controllers here, load them via the templates
  // this has to do with the way scope works in angular it needs to be applied to the ion-content directive
  // this will attach scope to the ion-view
  $stateProvider

    .state('login', {
      url: "/login",
      templateUrl: "templates/login.html"
    })
    .state('logout', {
      url: "/logout",
      controller: "LogoutCtrl"
    })
    .state('register', {
      url: "/register",
      templateUrl: "templates/register.html"
    })
    .state('account', {
      url: "/account",
      templateUrl: "templates/account.html",
      resolve: {
        // controller will not be loaded until $requireAuth resolves
        // Auth refers to our $firebaseAuth wrapper in the example above
        "currentAuth": ["Auth", function(Auth) {
          // $requireAuth returns a promise so the resolve waits for it to complete
          // If the promise is rejected, it will throw a $stateChangeError (see above)
          return Auth.$requireAuth();
        }]
      }
    })
    /*
     * Our Wine Views
     */
    .state('wines', {
      abstract: true,
      url: "/wines",
      template: "<ion-nav-view/>",
      resolve: {
        // controller will not be loaded until $requireAuth resolves
        // Auth refers to our $firebaseAuth wrapper in the example above
        currentAuth: function (Auth) {
          // $requireAuth returns a promise so the resolve waits for it to complete
          // If the promise is rejected, it will throw a $stateChangeError (see above)
          return Auth.$requireAuth();
        }
      }
    })
    .state('wines.index', {
      url: "/index",
      templateUrl: "templates/wines.index.html"
    })
    .state('wines.detail', {
      url: "/:id",
      templateUrl: "templates/wines.detail.html"
    })
    .state('wines.note', {
      url: "/:id/note",
      templateUrl: "templates/wines.note.html",
      resolve: {
        // controller will not be loaded until these promises resolve
        // Wines refers to our Wines service
        Wine: function ($stateParams, Wines) {
          return Wines.$object($stateParams.id).$loaded();
        }
      },
      controller: "WineNoteCtrl"
    })
    .state('note', {
      url: "/notes/:id",
      templateUrl: "templates/note.html",
      resolve: {
        Note: function ($stateParams, Notes) {
          return Notes.$object($stateParams.id).$loaded();
        }
      },
      controller: "NoteCtrl"
    })
    .state('wines.edit', {
      url: "/:id/edit",
      templateUrl: "templates/wines.edit.html",
      resolve: {
        // controller will not be loaded until these promises resolve
        // Wines refers to our Wines service
        Wine: function ($stateParams, Wines) {
          return Wines.$object($stateParams.id).$loaded();
        },
        // Kits refers to our Kits service
        Products: function (Kits) {
          // $requireAuth returns a promise so the resolve waits for it to complete
          // If the promise is rejected, it will throw a $stateChangeError (see above)
          return Kits.$array.getProductsByBrand('Wine Expert');
        }
      },
      controller: "WineEditCtrl"
    });

  // if we aren't at a known route
  $urlRouterProvider.otherwise("/wines/index");

});

app.run(function($ionicPlatform) {
  $ionicPlatform.ready(function() {
    // Hide the accessory bar by default (remove this to show the accessory bar above the keyboard
    // for form inputs)
    if(window.cordova && window.cordova.plugins.Keyboard) {
      cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);
    }
    if(window.StatusBar) {
      StatusBar.styleDefault();
    }
  });
});

// for states that require authentication send them to login
app.run(["$rootScope", "$state", function($rootScope, $state) {
  $rootScope.$on("$stateChangeError", function(event, toState, toParams, fromState, fromParams, error) {
    // throw the error
    console.warn(error);
    // We can catch the error thrown when the $requireAuth promise is rejected
    // and redirect the user back to the home page
    if (error === "AUTH_REQUIRED") {
      $state.go("login");
    }
  });
}]);

app.controller('AccountCtrl', ['$scope', '$state', 'Auth', 'Users', function($scope, $state, Auth, Users) {

  // get the details on the user
  //

}]);

// Login Controller before everything
app.controller('LoginCtrl', ['$scope', '$state', '$timeout', 'Auth', function($scope, $state, $timeout, Auth) {

  // remove the error if the user makes changes to the user model
  $scope.error = null;

  // check if there is a problem with the username
  $scope.$watch('user.email', function (newValue, oldValue) {
    if ($scope.error && $scope.error.code === 'INVALID_USER') {
      $scope.error = null;
    }
  });


  // check if there is a problem with the password
  $scope.$watch('user.password', function (newValue, oldValue) {
    if ($scope.error && $scope.error.code === 'INVALID_PASSWORD') {
      $scope.error = null;
    }
  });

  $scope.user = {};

  // login the old fashioned way with a email/pw
  $scope.simpleLogin = function () {
    Auth.$authWithPassword($scope.user).then(function(authData) {
      // what a success!
      console.log("Logged in as:", authData.uid);
      $state.go('wines.index');
    }).catch(function(error) {
      $scope.error = error;
      console.log(error.code);
    });
  };

}]);

app.controller('LogoutCtrl', ['$scope', '$state', 'Auth', function($scope, $state, Auth) {
  Auth.$unauth();
  console.log('Logged out');
  $state.go('login');
}]);

// Login Controller before everything
app.controller('NoteCtrl', ['$scope', '$state', '$stateParams', 'Auth', 'Note',  function($scope, $state, $stateParams, Auth, Note) {

  Note
    .$bindTo($scope, 'note')
    .then(function () {
      // do something
      console.log($scope.note);
    });

}]);

// Login Controller before everything
app.controller('RegisterCtrl', ['$scope', '$state', 'Auth', function($scope, $state, Auth) {

  // TODO: Switch to the Auth Service
  // TODO: User promises instead of callbacks

  // create our empty scope user
  $scope.user = {};

  // create our empty scope error
  $scope.error = null;

  // make sure the user has confirmed their password
  $scope.$watch('user.password2', function(newValue, oldValue) {
    if (newValue !== $scope.user.password) {
      $scope.error = {
        code: "INVALID_PASSWORD",
        message: "Passwords don't match."
      };
    } else {
      $scope.error = null;
    }
  });

  // login the old fashioned way with a email/pw
  $scope.register = function () {
    fb.createUser($scope.user, function (error, userData) {
      if (error) {
        // do something about the error
        console.log("Error creating user:", error);
      } else {
        // we have successfully created a user. Now, log them in and redirect them home to the wines page.
        // TODO: This should probably be in a then statement and not nested

        fb.authWithPassword($scope.user, function (error, authData) {

          if (error) {
            console.log('Error logging in user: ', error);
          } else {

            // successfully logged the user in.
            console.log("Authenticated successfully with payload:", authData);
            $state.go('wines.index');
          }
        });

      }
    });

  };

}]);

// Login Controller before everything
app.controller('WineDetailCtrl', ['$scope', '$state', '$stateParams', '$ionicPopup', 'Auth', 'Wines', 'Kits', 'Notes',  function($scope, $state, $stateParams, $ionicPopup, Auth, Wines, Kits, Notes) {

  // TODO: this should be a resolve
  var Wine = Wines.$object($state.params.id);

  Wine
    .$bindTo($scope, 'wine')
    .then(function () {
      // do something
    });

  $scope.notes = Notes.$array.getNotesByWine(Wine.$id);

  Wine
    .$watch(function () {

      // check if the wine is still a draft
      // if ($scope.wine.name && $scope.wine.kit.brand && $scope.wine.kit.product && $scope.wine.varietal) {
      //   $scope.wine.stage = 'ready';
      // } else {
      //   $scope.wine.stage = 'draft';
      // }

    });

}]);

app.controller('WineEditCtrl', ['$scope', '$state', '$stateParams', '$ionicPopup', 'Auth', 'Kits', 'Products', 'Wine', function($scope, $state, $stateParams, $ionicPopup, Auth, Kits, Products, Wine) {

  $scope.filter = {
    "products": Products,
    "kits": false
  };

  Wine.$bindTo($scope, 'wine').then(function () {
    $scope.filter.kits = Kits.$array.filterByProduct($scope.wine.kit.product);
  });

  $scope.updateNames = function () {
    if ($scope.wine.kit.product) {
      $scope.filter.kits = Kits.$array.filterByProduct($scope.wine.kit.product);
    }
  };

  // delete wine function
  $scope.deleteWine = function (id) {

    var confirmPopup = $ionicPopup.confirm({
      title: 'Delete Wine',
      template: 'Are you sure you want to delete this wine?',
      okType: 'button-assertive',
      okText: 'Delete'
    });

    confirmPopup.then(function(res) {

      if(res) {

        Wines.$array
          .$remove(Wines.$array.$getRecord(id))
          .then( function (ref) {
            // wine deleted
            $state.go('wines.index');
          }, function (err) {
            // some error happened
            console.warn(err);
          });

      } else {

        // the user canceled delete
        // console.log('You are not sure about ' + id);

      }

    });
  };

}]);

app.controller('WineNoteCtrl', ['$scope', '$state', '$stateParams', 'Auth', 'Wine', 'Notes', function($scope, $state, $stateParams, Auth, Wine, Notes) {

  Wine.$bindTo($scope, 'wine');
  $scope.note = {
    "event": false,
    "measurements": false,
    "specific_gravity": null,
    "color": null
  };

  $scope.createNote = function() {
    console.log('Note:');
    console.log($scope.note);

    Notes.$array.$add({
        "uid": Auth.$getAuth().uid,
        "wine_id": Wine.$id,
        "created_on": moment().format(),
        "edited_on": moment().format(),
        "message": $scope.note.message,
        "event": $scope.note.event,
        "measurements": $scope.note.measurements,
        "specific_gravity": $scope.note.specific_gravity,
        "color": $scope.note.color
    }).then( function (ref) {
      $scope.note = {
        "event": false,
        "measurements": false,
        "specific_gravity": null,
        "color": null
      };
      $state.go('wines.detail', {'id': Wine.$id });
    });
  };

}]);

// Login Controller before everything
app.controller('WinesCtrl', ['$scope', '$state', '$ionicPopover', '$ionicPopup', 'Auth', 'Wines', function($scope, $state, $ionicPopover, $ionicPopup, Auth, Wines) {

  // get a list of the user's wines
  $scope.wines = Wines.$array.getMyWines();
  $scope.newWine = {};

  // .fromTemplateUrl() method
  $ionicPopover.fromTemplateUrl('templates/wines.create.popover.html', {
    scope: $scope
  }).then(function(popover) {
    $scope.popover = popover;
  });

  $scope.active = 'kit';
  $scope.setActive = function (type) {
    console.log($scope.newWine.title);
    $scope.active = type;
  };
  $scope.isActive = function (type) {
    return type === $scope.active;
  };

  $scope.openPopover = function ($event) {
    $scope.popover.show($event);
  };

  $scope.closePopover = function () {
    $scope.popover.hide();
  };

  $scope.createWine = function () {

    // add the new wine to firebase
    Wines.$array.$add({
      "uid": Auth.$getAuth().uid,
      "name": $scope.newWine.title,
      "type": $scope.active,
      "created_on": moment().format(),
      "stage": "draft"
    })
    .then(function (ref) {
      // return our object to normal
      $scope.newWine.title = null;

      var id = ref.key();
      // list.$indexFor(id); // returns location in the array

      // hide the popover
      $scope.popover.hide();

      // and take us to the create wine view with our new wine
      $state.go('wines.edit', {"id": id});
    });

  };

  $scope.deleteWine = function (id) {

    var confirmPopup = $ionicPopup.confirm({
      title: 'Delete Wine',
      template: 'Are you sure you want to delete this wine?',
      okType: 'button-assertive',
      okText: 'Delete'
    });

    confirmPopup.then(function(res) {

      if(res) {

        Wines.$array
          .$remove(Wines.$array.$getRecord(id))
          .then( function (ref) {
            // wine deleted
          }, function (err) {
            // some error happened
            console.warn(err);
          });

      } else {

        // the user canceled delete
        // console.log('You are not sure about ' + id);

      }

    });
  };

}]);

app.factory("Auth", ["$firebaseAuth",
  function($firebaseAuth) {
    return $firebaseAuth(fb);
  }
]);

app.factory("Kits", ['$q', '$firebaseArray', '$firebaseObject', 'Auth', function($q, $firebaseArray, $firebaseObject, Auth) {
  var itemsRef = new Firebase("https://winemaker-notes.firebaseio.com/kits");

  // build our wines $firebaseArray
  // but let's extend it so that we can do special things
  var Kits = $firebaseArray.$extend({

    // @param: String brand
    filterByBrand: function (brand) {
      var query = itemsRef.orderByChild('brand').equalTo(brand);
      return $firebaseArray(query);
    },
    getProductsByBrand: function (brand) {

      // return a promise
      return $q(function (resolve, reject) {
        var query = itemsRef.orderByChild('brand').equalTo(brand);
        var kits = $firebaseArray(query);

        // with a list of unique products given a filter by brand
        // once the data has loaded
        kits.$loaded()
          .then(function (data) {
            var products = _.chain(data).map('product').uniq().value();
            resolve(products);
          }, function (err) {
            reject(err);
          });
      });
    },
    getVarietalsByBrand: function (brand) {

      // return a promise
      return $q(function (resolve, reject) {
        var query = itemsRef.orderByChild('brand').equalTo(brand);
        var kits = $firebaseArray(query);

        // with a list of unique varietals given a filter by brand
        // once the kits have loaded
        kits.$loaded()
          .then(function (data) {
            var varietals = _.chain(data).map('varietal').uniq().value();
            resolve(varietals);
          }, function (err) {
            reject(err);
          });

      });
    },

    // @param: String varietal
    filterByVarietal: function (varietal) {
      var query = itemsRef.orderByChild('varietal').equalTo(varietal);
      return $firebaseArray(query);
    },
    getBrandsByVarietal: function (varietal) {

      // return a promise
      return $q(function (resolve, reject) {
        var query = itemsRef.orderByChild('varietal').equalTo(varietal);
        var kits = $firebaseArray(query);

        // with a list of unique brands given a filter by varietal
        // once the kits have loaded
        kits.$loaded()
          .then(function (data) {
            var brands = _.chain(data).map('brand').uniq().value();
            resolve(brands);
          }, function (err) {
            reject(err);
          });

      });
    },

    // @param: String product
    filterByProduct: function (product) {
      var query = itemsRef.orderByChild('product').equalTo(product);
      return $firebaseArray(query);      
    },
    getNamesByProduct: function (product) {
      // return a promise
      return $q(function (resolve, reject) {
        var query = itemsRef.orderByChild('product').equalTo(product);
        var kits = $firebaseArray(query);

        kits.$loaded()
          .then(function (data) {
            var names = _.chain(data).map('name').uniq().value();
            resolve(names);
          }, function (err) {
            reject(err);
          });
      });
    }
  });

  return {
    "$array": Kits(itemsRef),
    "$object": function (objectId) {
      return $firebaseObject(itemsRef.child(objectId));
    }
  };
}]);

app.factory("Notes", ['$firebaseArray', '$firebaseObject', 'Auth', function($firebaseArray, $firebaseObject, Auth) {
  var itemsRef = new Firebase("https://winemaker-notes.firebaseio.com/notes");

  // build our wines $firebaseArray
  // but let's extend it so that we can do special things
  var Notes = $firebaseArray.$extend({
    getNotesByWine: function (wine_id) {
      var query = itemsRef.orderByChild('wine_id').equalTo(wine_id);
      return $firebaseArray(query);
    }
  });

  return {
    "$array": Notes(itemsRef),
    "$object": function (objectId) {
      return $firebaseObject(itemsRef.child(objectId));
    }
  };
}]);

app.factory('User', ['$firebaseAuth', '$firebaseObject', function($firebaseAuth, $firebaseObject) {
  var usersRef = new Firebase("https//winemaker-notes.firebaseio.com/users");
  return $firebaseObject(userRef);
}]);

app.factory("Wines", ['$firebaseArray', '$firebaseObject', 'Auth', function($firebaseArray, $firebaseObject, Auth) {
  var itemsRef = new Firebase("https://winemaker-notes.firebaseio.com/wines");

  // build our wines $firebaseArray
  // but let's extend it so that we can do special things
  var Wines = $firebaseArray.$extend({
    getMyWines: function () {
      var query = itemsRef.orderByChild('uid').equalTo(Auth.$getAuth().uid);
      return $firebaseArray(query);
    }
  });

  return {
    "$array": Wines(itemsRef),
    "$object": function (objectId) {
      return $firebaseObject(itemsRef.child(objectId));
    }
  };
}]);

app.filter('unique', function() {
    return function (array, field) {
        return _.uniq(array, function(a) { return a[field]; });
    };
});
